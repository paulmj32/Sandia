#### LOAD PACKAGES and SET DIRECTORY 
options(java.parameters = "-Xmx7g")
library(bartMachine)
set_bart_machine_num_cores(4)
library(lme4)
library(corrplot)
library(viridis)
library(tidyverse)
library(tidycensus) 
library(sf)
library(terra)
library(stars)
library(raster) #make sure ncdf4 package is installed 
library(lubridate)
library(spdep)
library(xgboost)

setwd("~/Documents/01_VECTOR.nosync/Sandia")

##############################################################################################
### LOAD VARIABLES ###########################################################################
##############################################################################################
# Get census tract map 
mycrs = 5070 #chose projected coordinate system: EPSG 5070 NAD83 Conus Albers
year=2019 # year for county boundaries 
options(tigris_use_cache = TRUE) #cache shapefiles for future sessions
soptions(tigris_use_cache = TRUE) #to cache shapefiles for future sessions
state = "Texas"
county = c("Harris County")
census_map = get_acs(geography = "tract", state = state, county = county,
                     variables=c("B01003_001"), year = year, geometry = TRUE, 
                     cache_table = TRUE)
census_map = census_map %>%
  mutate(POPULATION = estimate) %>%
  dplyr::select(GEOID, NAME, POPULATION) %>% 
  st_transform(mycrs) # project to Conic Equal Area Albers, EPSG:5070 
census_map_area = census_map %>%  
  mutate(AREA = as.vector(st_area(census_map))) %>% #sq-meters; as.vector removes units suffix 
  mutate(DENSITY = POPULATION / AREA * 1000^2) #population per sq-km 

load(file = "./Data/census_map_nlcd.Rda")  #NLCD
census_map_nlcd = census_map_nlcd %>% st_set_geometry(NULL)
load(file = "./Data/census_map_dem.Rda") #DEM
census_map_dem = census_map_dem %>% st_set_geometry(NULL)
load(file = "./Data/census_map_rz.Rda") #Root Zone
census_map_rz = census_map_rz %>% st_set_geometry(NULL)
load(file = "./Data/census_map_social.Rda") #Socio-economic
census_map_social = census_map_social %>% st_set_geometry(NULL)
load(file = "./Data/census_map_spi.Rda") #SPI 
census_map_spi = census_map_spi %>% st_set_geometry(NULL)
#load(file = "./Data/census_map_soil_day.Rda") #Soil Moisture
load(file = "./Data/census_map_WINDmax.Rda") #Hurricane Forecast
census_map_WINDmax = census_map_WINDmax %>% st_set_geometry(NULL)

census_map_CLEAN = census_map_area %>%
  dplyr::select(GEOID, DENSITY) %>%
  inner_join(dplyr::select(census_map_nlcd, c(GEOID, Developed:Wetlands)), by = "GEOID") %>%
  inner_join(dplyr::select(census_map_dem, c(GEOID, DEM_mean:DEM_max)), by = "GEOID") %>%
  inner_join(dplyr::select(census_map_rz, c(GEOID, RZ_mean:RZ_mode)), by = "GEOID") %>%
  inner_join(dplyr::select(census_map_social, c(GEOID, 1, 6:ncol(census_map_social))), by = "GEOID") %>%
  inner_join(dplyr::select(census_map_spi, c(GEOID, spi03_mean:spi24_mean)), by = "GEOID") %>%
  #inner_join(dplyr::select(census_map_soil_day, c(GEOID, soil10_3dLAG:soil100_3dLAG)), by = "GEOID") %>%
  inner_join(census_map_WINDmax, by = "GEOID") %>%
  rename(spi03_lag = spi03_mean, spi12_lag = spi12_mean, spi24_lag = spi24_mean, 
         #soil10_lag = soil10_3dLAG, soil40_lag = soil40_3dLAG, soil100_lag = soil100_3dLAG,
         Density = DENSITY)

##############################################################################################
### MODELS ###################################################################################
##############################################################################################
### XGB Final Model
census_map_FINAL = census_map_CLEAN
load(file = "xgb_final_model.Rda") 
X = census_map_FINAL %>%
  dplyr::select(xgb_final_model$feature_names) %>%
  st_set_geometry(NULL) %>%
  as.matrix()
predictions = predict(xgb_final_model, X)

# Without dynamic weather
X_static = census_map_FINAL %>%
  dplyr::select(xgb_final_model$feature_names) %>%
  mutate(WIND_max = NA) %>% 
  st_set_geometry(NULL) %>%
  as.matrix()
predictions_static = predict(xgb_final_model, X_static)

# ### BART Final Model
# #impute missing values based on neighboring polygons
# # https://stackoverflow.com/questions/62915873/how-to-fill-missing-values-based-on-neighboring-polygons-in-r
# which(is.na(census_map_CLEAN), arr.ind = T)
# index_all = st_touches(census_map_CLEAN, census_map_CLEAN) #find all neighbors 
# varnames = colnames(census_map_CLEAN)
# varnames = varnames[!(varnames %in%c("GEOID", "geometry"))]
# imputeNN = function(y){ifelse(is.na(y), apply(index, 1, function(i){mean(y[i], na.rm = T)}), y)} #impute average of neighbors
# census_map_FINAL = census_map_CLEAN %>% 
#   mutate(across(all_of(varnames), ~ imputeNN(.x)))
# load(file = "bart_civic.Rda")  #load trained model 
# X = census_map_FINAL %>%
#   dplyr::select(c("spi24_lag","Density", "Developed", "QMOHO", "soil100_lag" , "QFEMALE", "QNATIVE", "spi12_lag", "Wetlands", "RZ_mean")) %>%
#   st_set_geometry(NULL)
# model_name = paste("Predicting Outages - No Weather Data - Harris County, TX")
# predictions = predict(bart, X)

##############################################################################################
### RISK MAP #################################################################################
##############################################################################################
Harris_map = census_map_FINAL %>%
  mutate(risk = predictions) %>%
  mutate(risk01 = (risk - min(predictions)) / (max(predictions) - min(predictions))) %>%
  mutate(risk_static = predictions_static) %>% 
  mutate(risk01_static = (risk_static - min(predictions_static)) / (max(predictions_static) - min(predictions_static)))

## Exploratory Spatial Analysis with spdep package
# https://walker-data.com/census-r/spatial-analysis-with-us-census-data.html#spatial-analysis-with-us-census-data
neighbors = poly2nb(Harris_map, queen = T) #any part of a polygon connecting to another polygon is a neighbor
weights = nb2listw(neighbors, style = "W") #weight-based (i.e., all neighbors sum to 1)
moran.test(Harris_map$risk01, weights) #Moran's I test: positive statistic and low p-value --> reject null hypothesis of spatial randomness
localg_weights = nb2listw(include.self(neighbors)) #include self as a neighbor for Local Gi* test
local_gistar = localG(Harris_map$risk01, localg_weights)
local_gistar_static = localG(Harris_map$risk01_static, localg_weights)

Harris_map$gistar = local_gistar
Harris_map$gistar_static = local_gistar_static
Harris_map = Harris_map %>%
  mutate(gistar01 = (gistar - min(local_gistar)) / (max(local_gistar) - min(local_gistar))) %>%
  mutate(gistar01_static = (gistar_static - min(local_gistar_static)) / (max(local_gistar_static) - min(local_gistar_static)))

gg2 = ggplot(Harris_map)+
  geom_sf(aes(fill = gistar01), color = NA) + 
  scale_fill_viridis_c(option="plasma", na.value = "grey50") +
  #geom_sf(fill = NA, show.legend = F, color = "black", lwd = 0.005)+
  #coord_sf(datum = NA) + #removes gridlines 
  #guides(fill = "none") + #removes legend
  #theme_minimal()  #removes background
  theme_dark() +
  labs(title = "Harris County - Power Outage Risk", fill = "Risk") + 
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_blank(),
        axis.title.y = element_blank()
  )
gg2

##########################################################################################################
### OUTPUTS FOR CIVIC ####################################################################################
##########################################################################################################
obj3_tracts = c('48201100000',
                '48201210100',
                '48201210400',
                '48201210500',
                '48201210600',
                '48201210700',
                '48201210800',
                '48201210900',
                '48201211000',
                '48201211100',
                '48201211200',
                '48201211300',
                '48201211400',
                '48201211500',
                '48201211600',
                '48201211700',
                '48201211900',
                '48201212300',
                '48201212400',
                '48201212500',
                '48201220100',
                '48201220200',
                '48201220300',
                '48201220400',
                '48201220500',
                '48201220600',
                '48201220700',
                '48201220800',
                '48201220900',
                '48201221000',
                '48201221100',
                '48201221200',
                '48201221300',
                '48201221400',
                '48201221500',
                '48201221600',
                '48201221700',
                '48201221800',
                '48201221900',
                '48201222000',
                '48201222100',
                '48201222200',
                '48201222300',
                '48201222401',
                '48201222402',
                '48201222501',
                '48201222502',
                '48201222503',
                '48201222600',
                '48201222700',
                '48201222800',
                '48201222900',
                '48201223001',
                '48201223002',
                '48201223100',
                '48201230100',
                '48201230200',
                '48201230300',
                '48201230400',
                '48201230500',
                '48201230600',
                '48201230700',
                '48201230800',
                '48201230900',
                '48201231000',
                '48201231100',
                '48201231200',
                '48201231300',
                '48201231400',
                '48201231500',
                '48201231600',
                '48201231700',
                '48201231800',
                '48201231900',
                '48201232000',
                '48201232100',
                '48201232200',
                '48201232301',
                '48201232302',
                '48201232401',
                '48201232402',
                '48201232403',
                '48201232500',
                '48201232600',
                '48201232701',
                '48201232702',
                '48201232800',
                '48201232900',
                '48201233001',
                '48201233002',
                '48201233003',
                '48201233101',
                '48201233102',
                '48201233103',
                '48201233200',
                '48201233300',
                '48201233400',
                '48201233500',
                '48201233600',
                '48201233701',
                '48201233702',
                '48201233703',
                '48201240100',
                '48201240400',
                '48201240501',
                '48201240502',
                '48201240600',
                '48201240701',
                '48201240702',
                '48201240801',
                '48201240802',
                '48201240901',
                '48201240902',
                '48201241000',
                '48201241101',
                '48201241102',
                '48201241103',
                '48201241200',
                '48201241300',
                '48201241400',
                '48201241500',
                '48201250100',
                '48201250200',
                '48201250301',
                '48201250302',
                '48201250401',
                '48201250402',
                '48201250500',
                '48201250600',
                '48201250701',
                '48201250702',
                '48201250800',
                '48201250900',
                '48201251100',
                '48201251200',
                '48201251300',
                '48201251402',
                '48201251501',
                '48201251502',
                '48201251503',
                '48201251600',
                '48201251700',
                '48201251800',
                '48201251901',
                '48201251902',
                '48201252000',
                '48201252100',
                '48201252200',
                '48201252301',
                '48201252302',
                '48201252400',
                '48201252500',
                '48201252600',
                '48201252700',
                '48201252800',
                '48201252900',
                '48201253000',
                '48201253100',
                '48201253200',
                '48201253300',
                '48201253400',
                '48201253500',
                '48201253600',
                '48201253700',
                '48201253800',
                '48201253900',
                '48201254000',
                '48201254100',
                '48201254200',
                '48201254300',
                '48201254400',
                '48201254500',
                '48201254600',
                '48201254700',
                '48201310100',
                '48201310200',
                '48201310300',
                '48201310400',
                '48201310500',
                '48201310600',
                '48201310700',
                '48201310800',
                '48201310900',
                '48201311000',
                '48201311100',
                '48201311200',
                '48201311300',
                '48201311400',
                '48201311500',
                '48201311600',
                '48201311700',
                '48201311800',
                '48201311900',
                '48201312000',
                '48201312200',
                '48201312300',
                '48201312400',
                '48201312500',
                '48201312600',
                '48201312700',
                '48201312800',
                '48201312900',
                '48201313000',
                '48201313100',
                '48201313200',
                '48201313300',
                '48201313400',
                '48201313500',
                '48201313600',
                '48201313700',
                '48201313800',
                '48201313900',
                '48201320100',
                '48201320200',
                '48201320500',
                '48201320601',
                '48201320602',
                '48201320700',
                '48201320800',
                '48201320900',
                '48201321000',
                '48201321100',
                '48201321200',
                '48201321300',
                '48201321401',
                '48201321402',
                '48201321500',
                '48201321600',
                '48201321700',
                '48201321800',
                '48201321900',
                '48201322000',
                '48201322100',
                '48201322200',
                '48201322600',
                '48201322700',
                '48201322800',
                '48201322900',
                '48201323000',
                '48201323100',
                '48201323200',
                '48201323300',
                '48201323400',
                '48201323500',
                '48201323600',
                '48201323701',
                '48201323702',
                '48201323801',
                '48201323802',
                '48201323900',
                '48201324000',
                '48201324100',
                '48201324200',
                '48201330100',
                '48201330200',
                '48201330301',
                '48201330302',
                '48201330303',
                '48201330400',
                '48201330500',
                '48201330600',
                '48201330700',
                '48201330800',
                '48201330900',
                '48201331100',
                '48201331200',
                '48201331300',
                '48201331400',
                '48201331500',
                '48201331601',
                '48201331602',
                '48201331700',
                '48201331800',
                '48201331900',
                '48201332000',
                '48201332100',
                '48201332200',
                '48201332300',
                '48201332400',
                '48201332500',
                '48201332600',
                '48201332700',
                '48201332800',
                '48201332900',
                '48201333000',
                '48201333100',
                '48201333201',
                '48201333202',
                '48201333300',
                '48201333500',
                '48201333600',
                '48201333700',
                '48201333800',
                '48201333901',
                '48201333902',
                '48201334001',
                '48201334003',
                '48201334100',
                '48201340100',
                '48201340201',
                '48201340202',
                '48201340203',
                '48201340302',
                '48201340700',
                '48201340900',
                '48201341000',
                '48201341100',
                '48201341301',
                '48201341400',
                '48201341501',
                '48201341502',
                '48201341600',
                '48201341700',
                '48201341800',
                '48201342001',
                '48201342002',
                '48201342100',
                '48201342200',
                '48201342300',
                '48201342400',
                '48201342500',
                '48201342700',
                '48201342800',
                '48201342900',
                '48201343000',
                '48201343100',
                '48201343200',
                '48201343301',
                '48201343302',
                '48201343600',
                '48201343700',
                '48201350100',
                '48201350200',
                '48201350300',
                '48201350400',
                '48201350500',
                '48201350602',
                '48201350700',
                '48201350801',
                '48201410100',
                '48201410200',
                '48201410300',
                '48201410401',
                '48201410402',
                '48201410500',
                '48201410600',
                '48201410701',
                '48201410702',
                '48201410800',
                '48201411000',
                '48201411100',
                '48201411501',
                '48201411700',
                '48201411800',
                '48201411900',
                '48201412200',
                '48201412300',
                '48201413000',
                '48201413201',
                '48201413300',
                '48201420100',
                '48201420200',
                '48201420300',
                '48201420400',
                '48201420500',
                '48201420600',
                '48201420900',
                '48201421000',
                '48201421101',
                '48201421102',
                '48201421201',
                '48201421202',
                '48201421300',
                '48201421401',
                '48201421402',
                '48201421403',
                '48201421500',
                '48201421600',
                '48201421700',
                '48201421800',
                '48201422000',
                '48201422100',
                '48201422200',
                '48201422301',
                '48201422302',
                '48201422401',
                '48201422402',
                '48201422500',
                '48201422600',
                '48201422701',
                '48201422702',
                '48201422800',
                '48201422900',
                '48201423000',
                '48201423100',
                '48201423201',
                '48201423202',
                '48201423301',
                '48201423302',
                '48201423401',
                '48201423402',
                '48201423500',
                '48201423600',
                '48201430100',
                '48201430800',
                '48201431000',
                '48201431102',
                '48201431201',
                '48201431301',
                '48201431501',
                '48201431801',
                '48201431802',
                '48201432001',
                '48201432100',
                '48201432200',
                '48201432300',
                '48201432400',
                '48201432500',
                '48201432600',
                '48201432701',
                '48201432702',
                '48201432801',
                '48201432802',
                '48201432901',
                '48201432902',
                '48201433001',
                '48201433002',
                '48201433003',
                '48201433100',
                '48201433201',
                '48201433202',
                '48201433300',
                '48201433400',
                '48201433501',
                '48201433502',
                '48201433600',
                '48201440100',
                '48201450100',
                '48201450200',
                '48201450300',
                '48201450400',
                '48201450500',
                '48201450600',
                '48201450801',
                '48201450802',
                '48201451001',
                '48201451002',
                '48201451100',
                '48201451300',
                '48201451401',
                '48201451402',
                '48201451403',
                '48201451601',
                '48201451602',
                '48201451700',
                '48201451800',
                '48201451901',
                '48201451902',
                '48201452000',
                '48201452100',
                '48201452202',
                '48201452300',
                '48201452400',
                '48201452500',
                '48201452600',
                '48201452700',
                '48201452801',
                '48201452802',
                '48201452900',
                '48201453000',
                '48201453100',
                '48201453200',
                '48201453300',
                '48201453401',
                '48201453402',
                '48201453403',
                '48201453501',
                '48201453502',
                '48201453601',
                '48201453602',
                '48201453700',
                '48201453800',
                '48201453900',
                '48201454000',
                '48201454100',
                '48201454200',
                '48201454301',
                '48201454302',
                '48201454501',
                '48201454600',
                '48201454800',
                '48201454900',
                '48201455101',
                '48201455300',
                '48201510100',
                '48201510200',
                '48201510300',
                '48201510400',
                '48201510500',
                '48201510600',
                '48201510800',
                '48201510900',
                '48201511002',
                '48201511100',
                '48201511200',
                '48201511301',
                '48201511302',
                '48201511400',
                '48201511500',
                '48201511600',
                '48201520100',
                '48201520200',
                '48201520300',
                '48201520400',
                '48201520500',
                '48201520601',
                '48201520602',
                '48201520700',
                '48201521200',
                '48201521300',
                '48201521400',
                '48201521500',
                '48201521600',
                '48201521700',
                '48201521800',
                '48201521900',
                '48201522000',
                '48201522100',
                '48201522201',
                '48201522202',
                '48201522301',
                '48201522302',
                '48201522401',
                '48201522402',
                '48201530100',
                '48201530200',
                '48201530300',
                '48201530400',
                '48201530500',
                '48201530600',
                '48201530700',
                '48201530800',
                '48201530900',
                '48201531000',
                '48201531100',
                '48201531200',
                '48201531300',
                '48201531400',
                '48201531500',
                '48201531800',
                '48201531900',
                '48201532001',
                '48201532002',
                '48201532100',
                '48201532200',
                '48201532300',
                '48201532400',
                '48201532501',
                '48201532502',
                '48201532600',
                '48201532700',
                '48201532800',
                '48201532900',
                '48201533000',
                '48201533100',
                '48201533200',
                '48201533300',
                '48201533400',
                '48201533500',
                '48201533600',
                '48201533701',
                '48201533702',
                '48201533801',
                '48201533802',
                '48201533901',
                '48201533902',
                '48201534001',
                '48201534002',
                '48201534003',
                '48201534100',
                '48201534201',
                '48201534202',
                '48201534203',
                '48201540100',
                '48201540200',
                '48201540501',
                '48201540502',
                '48201540601',
                '48201540602',
                '48201540700',
                '48201540800',
                '48201540901',
                '48201540902',
                '48201541001',
                '48201541002',
                '48201541003',
                '48201541100',
                '48201541201',
                '48201541202',
                '48201541203',
                '48201541300',
                '48201541400',
                '48201541500',
                '48201541601',
                '48201541602',
                '48201541700',
                '48201541800',
                '48201541900',
                '48201542000',
                '48201542101',
                '48201542102',
                '48201542200',
                '48201542301',
                '48201542302',
                '48201542400',
                '48201542600',
                '48201542700',
                '48201542900',
                '48201543001',
                '48201543002',
                '48201543003',
                '48201543100',
                '48201543200',
                '48201550100',
                '48201550200',
                '48201550301',
                '48201550302',
                '48201550401',
                '48201550402',
                '48201550500',
                '48201550601',
                '48201550602',
                '48201550603',
                '48201550700',
                '48201550800',
                '48201550900',
                '48201551000',
                '48201551100',
                '48201551200',
                '48201551300',
                '48201551400',
                '48201551500',
                '48201551600',
                '48201551701',
                '48201551702',
                '48201551703',
                '48201551800',
                '48201551900',
                '48201552001',
                '48201552002',
                '48201552101',
                '48201552102',
                '48201552103',
                '48201552200',
                '48201552301',
                '48201552302',
                '48201552400',
                '48201552500',
                '48201552601',
                '48201552602',
                '48201552700',
                '48201552800',
                '48201552900',
                '48201553001',
                '48201553002',
                '48201553100',
                '48201553200',
                '48201553300',
                '48201553401',
                '48201553402',
                '48201553403',
                '48201553500',
                '48201553600',
                '48201553700',
                '48201553801',
                '48201553802',
                '48201553900',
                '48201554001',
                '48201554002',
                '48201554102',
                '48201554200',
                '48201554301',
                '48201554302',
                '48201554401',
                '48201554402',
                '48201554403',
                '48201554501',
                '48201554600',
                '48201554700',
                '48201554801',
                '48201554802',
                '48201554901',
                '48201554902',
                '48201554903',
                '48201555000',
                '48201555100',
                '48201555200',
                '48201555301',
                '48201555302',
                '48201555303',
                '48201555401',
                '48201555402',
                '48201555501',
                '48201555502',
                '48201555600',
                '48201555701',
                '48201556000',
                '48201980100',
                '48201314002',
                '48201314400',
                '48201341201',
                '48201431202',
                '48201432002',
                '48201521000',
                '48201521100',
                '48201980000')

obj3_out = Harris_map %>%
  #dplyr::filter(GEOID %in% obj3_tracts) %>%
  arrange(GEOID) %>%
  dplyr::select(GEOID, risk01, gistar01) %>%
  st_set_geometry(NULL)
write.csv(obj3_out, file = "./Data/obj3_out.csv", row.names = FALSE)
